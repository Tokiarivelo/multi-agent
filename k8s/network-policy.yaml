# Network Policies for Multi-Agent Platform
# 
# WARNING: Network policies require a CNI plugin that supports them
# (Calico, Cilium, Weave Net, etc.)
#
# These policies implement the principle of least privilege:
# - Services can only communicate with services they need
# - Database access is restricted
# - External traffic only through gateway
#
# To enable: kubectl apply -f network-policy.yaml

---
# Default Deny All
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
  namespace: multi-agent
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress

---
# Allow DNS for all pods
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns
  namespace: multi-agent
spec:
  podSelector: {}
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
# Gateway Service Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: gateway-service-policy
  namespace: multi-agent
spec:
  podSelector:
    matchLabels:
      app: gateway-service
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from ingress controller
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - protocol: TCP
          port: 3000
    # Allow from frontend
    - from:
        - podSelector:
            matchLabels:
              app: frontend
      ports:
        - protocol: TCP
          port: 3000
  egress:
    # Allow to orchestration service
    - to:
        - podSelector:
            matchLabels:
              app: orchestration-service
      ports:
        - protocol: TCP
          port: 3001
    # Allow to PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app: postgres
      ports:
        - protocol: TCP
          port: 5432
    # Allow to NATS
    - to:
        - podSelector:
            matchLabels:
              app: nats
      ports:
        - protocol: TCP
          port: 4222
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
# Orchestration Service Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: orchestration-service-policy
  namespace: multi-agent
spec:
  podSelector:
    matchLabels:
      app: orchestration-service
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from gateway
    - from:
        - podSelector:
            matchLabels:
              app: gateway-service
      ports:
        - protocol: TCP
          port: 3001
  egress:
    # Allow to all microservices
    - to:
        - podSelector:
            matchLabels:
              app: agent-service
      ports:
        - protocol: TCP
          port: 3002
    - to:
        - podSelector:
            matchLabels:
              app: tool-service
      ports:
        - protocol: TCP
          port: 3003
    - to:
        - podSelector:
            matchLabels:
              app: model-service
      ports:
        - protocol: TCP
          port: 3004
    - to:
        - podSelector:
            matchLabels:
              app: execution-service
      ports:
        - protocol: TCP
          port: 3006
    # Allow to PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app: postgres
      ports:
        - protocol: TCP
          port: 5432
    # Allow to NATS
    - to:
        - podSelector:
            matchLabels:
              app: nats
      ports:
        - protocol: TCP
          port: 4222
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
# Agent Service Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: agent-service-policy
  namespace: multi-agent
spec:
  podSelector:
    matchLabels:
      app: agent-service
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from orchestration
    - from:
        - podSelector:
            matchLabels:
              app: orchestration-service
      ports:
        - protocol: TCP
          port: 3002
  egress:
    # Allow to model service
    - to:
        - podSelector:
            matchLabels:
              app: model-service
      ports:
        - protocol: TCP
          port: 3004
    # Allow to tool service
    - to:
        - podSelector:
            matchLabels:
              app: tool-service
      ports:
        - protocol: TCP
          port: 3003
    # Allow to PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app: postgres
      ports:
        - protocol: TCP
          port: 5432
    # Allow to NATS
    - to:
        - podSelector:
            matchLabels:
              app: nats
      ports:
        - protocol: TCP
          port: 4222
    # Allow to external APIs (OpenAI, Anthropic)
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
# Tool Service Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: tool-service-policy
  namespace: multi-agent
spec:
  podSelector:
    matchLabels:
      app: tool-service
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: agent-service
      ports:
        - protocol: TCP
          port: 3003
    - from:
        - podSelector:
            matchLabels:
              app: orchestration-service
      ports:
        - protocol: TCP
          port: 3003
  egress:
    # Allow to PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app: postgres
      ports:
        - protocol: TCP
          port: 5432
    # Allow to NATS
    - to:
        - podSelector:
            matchLabels:
              app: nats
      ports:
        - protocol: TCP
          port: 4222
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
# Model Service Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: model-service-policy
  namespace: multi-agent
spec:
  podSelector:
    matchLabels:
      app: model-service
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: agent-service
      ports:
        - protocol: TCP
          port: 3004
    - from:
        - podSelector:
            matchLabels:
              app: orchestration-service
      ports:
        - protocol: TCP
          port: 3004
  egress:
    # Allow to PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app: postgres
      ports:
        - protocol: TCP
          port: 5432
    # Allow to NATS
    - to:
        - podSelector:
            matchLabels:
              app: nats
      ports:
        - protocol: TCP
          port: 4222
    # Allow to external APIs (OpenAI, Anthropic)
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
# Vector Service Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: vector-service-policy
  namespace: multi-agent
spec:
  podSelector:
    matchLabels:
      app: vector-service
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              component: api
      ports:
        - protocol: TCP
          port: 3005
  egress:
    # Allow to Qdrant
    - to:
        - podSelector:
            matchLabels:
              app: qdrant
      ports:
        - protocol: TCP
          port: 6333
        - protocol: TCP
          port: 6334
    # Allow to PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app: postgres
      ports:
        - protocol: TCP
          port: 5432
    # Allow to NATS
    - to:
        - podSelector:
            matchLabels:
              app: nats
      ports:
        - protocol: TCP
          port: 4222
    # Allow to external APIs (OpenAI for embeddings)
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: TCP
          port: 443
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
# Execution Service Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: execution-service-policy
  namespace: multi-agent
spec:
  podSelector:
    matchLabels:
      app: execution-service
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: orchestration-service
      ports:
        - protocol: TCP
          port: 3006
  egress:
    # Allow to PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app: postgres
      ports:
        - protocol: TCP
          port: 5432
    # Allow to NATS
    - to:
        - podSelector:
            matchLabels:
              app: nats
      ports:
        - protocol: TCP
          port: 4222
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
# Frontend Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: frontend-policy
  namespace: multi-agent
spec:
  podSelector:
    matchLabels:
      app: frontend
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow from ingress controller
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - protocol: TCP
          port: 3001
  egress:
    # Allow to gateway service
    - to:
        - podSelector:
            matchLabels:
              app: gateway-service
      ports:
        - protocol: TCP
          port: 3000
    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53

---
# PostgreSQL Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgres-policy
  namespace: multi-agent
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
    - Ingress
  ingress:
    # Allow from all services
    - from:
        - podSelector:
            matchLabels:
              component: api
      ports:
        - protocol: TCP
          port: 5432
    - from:
        - podSelector:
            matchLabels:
              component: orchestration
      ports:
        - protocol: TCP
          port: 5432
    - from:
        - podSelector:
            matchLabels:
              component: agent
      ports:
        - protocol: TCP
          port: 5432

---
# Qdrant Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: qdrant-policy
  namespace: multi-agent
spec:
  podSelector:
    matchLabels:
      app: qdrant
  policyTypes:
    - Ingress
  ingress:
    # Allow from vector service
    - from:
        - podSelector:
            matchLabels:
              app: vector-service
      ports:
        - protocol: TCP
          port: 6333
        - protocol: TCP
          port: 6334
    # Allow from LoadBalancer (external access)
    - ports:
        - protocol: TCP
          port: 6333
        - protocol: TCP
          port: 6334

---
# NATS Policy
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: nats-policy
  namespace: multi-agent
spec:
  podSelector:
    matchLabels:
      app: nats
  policyTypes:
    - Ingress
  ingress:
    # Allow from all services
    - from:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 4222
        - protocol: TCP
          port: 8222
